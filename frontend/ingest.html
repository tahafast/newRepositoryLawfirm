<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Upload documents â€” BRAG AI</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./theme.js"></script>
  <script src="./config.js" type="module"></script>
</head>
<body>
  <header class="header">
    <a class="brand" href="./index.html" id="brand-link"><div class="logo">B</div><strong>BRAG AI</strong></a>
    <div class="toolbar">
      <a class="nav-link" href="./chat.html">Chat</a>
      <button class="btn-ghost" data-theme-toggle onclick="__bragaiTheme.toggleTheme()">ðŸŒ™ Dark</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="kicker">Ingestion</div>
      <h2 style="margin:6px 0 12px;">Upload documents</h2>
      <p class="small">PDF, DOCX, TXT. Files will be chunked, embedded and indexed in Qdrant.</p>

      <form id="uploadForm">
        <input id="files" type="file" multiple style="margin:14px 0 10px;"/>
        <div class="cta">
          <button class="btn" type="submit">Upload</button>
          <a class="btn-secondary" href="./chat.html">Go to Chat</a>
        </div>

        <div class="progress-wrap" id="progressWrap" style="display:none;">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <p class="small" id="progressText" style="margin-top:8px;">Preparingâ€¦</p>
        </div>

        <div id="statusBox" class="status" style="display:none;"></div>
      </form>
    </section>
  </main>

  <script type="module">
    import { API_BASE } from "./config.js";
    
    document.getElementById('brand-link').addEventListener('click', (e) => {
      e.preventDefault(); window.location.href = './index.html';
    });

    const form = document.getElementById('uploadForm');
    const filesInput = document.getElementById('files');
    const progressWrap = document.getElementById('progressWrap');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusBox = document.getElementById('statusBox');

    function setProgress(pct, text){
      progressWrap.style.display = 'block';
      progressFill.style.width = pct + '%';
      progressText.textContent = text || (pct + '%');
    }

    function setStatus(ok, msg){
      statusBox.style.display = 'block';
      statusBox.className = 'status ' + (ok ? 'success' : 'error');
      statusBox.textContent = msg;
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      statusBox.style.display = 'none';
      const files = filesInput.files;
      if(!files || !files.length){ setStatus(false, 'Please choose at least one file.'); return; }

      const data = new FormData();
      for (const f of files) data.append('files', f);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', API_BASE + '/api/v1/lawfirm/upload-document');

      xhr.upload.addEventListener('progress', (ev) => {
        if (ev.lengthComputable) {
          const pct = Math.round((ev.loaded / ev.total) * 100);
          setProgress(pct, 'Uploadingâ€¦ ' + pct + '%');
        } else {
          setProgress(15, 'Uploadingâ€¦');
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          // ingestion done (server will process chunks after upload)
          setProgress(100, 'Processing & indexingâ€¦');
          try {
            const res = JSON.parse(xhr.responseText || '{}');
            if (xhr.status >= 200 && xhr.status < 300) {
              setStatus(true, `âœ… Uploaded ${Array.isArray(res.files)? res.files.length : ''} file(s) successfully. You can start chatting now.`);
            } else {
              setStatus(false, `âŒ Upload failed: ${res.detail || res.message || 'Unknown error'}`);
            }
          } catch (e) {
            if (xhr.status >= 200 && xhr.status < 300) {
              setStatus(true, 'âœ… Upload complete. You can start chatting now.');
            } else {
              setStatus(false, 'âŒ Upload failed.');
            }
          }
        }
      };

      xhr.send(data);
      setProgress(5, 'Starting uploadâ€¦');
    });
  </script>
</body>
</html>
