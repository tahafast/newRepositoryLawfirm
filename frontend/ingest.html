<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Upload documents — BRAG AI</title>
  <link rel="stylesheet" href="./styles.css?v=1.1.3"/>
  <script src="./theme.js"></script>
  <script src="./config.js" type="module"></script>
</head>
<body>
  <header class="header flex items-center justify-between px-6 py-4">
    <div class="flex items-center space-x-3">
      <div class="logo bg-blue-600 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center text-lg">B</div>
      <span class="brand text-lg font-semibold tracking-wide text-gray-900 dark:text-white">BRAG AI (LEGAL)</span>
    </div>
    <nav class="flex items-center space-x-4">
      <a href="./index.html" class="text-sm font-medium hover:underline">Home</a>
      <a href="./ingest.html" class="text-sm font-medium hover:underline">Ingest</a>
      <a href="./chat.html" class="text-sm font-medium hover:underline">Chat</a>
      <button onclick="__bragaiTheme.toggleTheme()" data-theme-toggle class="theme-toggle border rounded-xl px-3 py-1 text-sm flex items-center">
        &#127769; Dark
      </button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="kicker">Ingestion</div>
      <h2 style="margin:6px 0 12px;">Upload documents</h2>
      <p class="small">PDF, DOCX, DOC, TXT. Files will be chunked, embedded and indexed in Qdrant.</p>

      <form id="uploadForm">
        <input id="files" type="file" multiple style="margin:14px 0 10px;"/>
        <div class="cta">
          <button class="btn" type="submit">Upload</button>
          <a class="btn-secondary" href="./chat.html">Go to Chat</a>
        </div>

        <div class="progress-wrap" id="progressWrap" style="display:none;">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <p class="small" id="progressText" style="margin-top:8px;">Preparing…</p>
        </div>

        <div id="statusBox" class="status" style="display:none;"></div>
      </form>
    </section>

    <!-- Indexed Documents Card -->
<section class="card mt-6 p-4" id="indexedDocsSection">
  <h2 class="text-lg font-bold mb-2">INDEX OVERVIEW</h2>
  <h3 class="text-xl font-semibold mb-4">Indexed documents</h3>
  <p class="text-sm text-muted mb-3">
    Search, sort, and preview chunks currently stored in the active alias.
  </p>

  <div class="flex items-center gap-2 mb-3">
    <input
      id="indexedDocsSearch"
      class="form-control w-full"
      placeholder="Search by filename"
    />
    <button id="indexedDocsShowAll" class="btn btn-primary whitespace-nowrap">
      Show all documents
    </button>
  </div>

  <div id="indexedDocsStatus" class="text-sm text-muted mb-2"></div>

  <div
    id="indexedDocsScrollBox"
    class="overflow-y-auto rounded-md border border-gray-700"
    style="max-height: 420px; min-height: 300px;"
  >
    <table class="table w-full text-sm">
      <thead class="sticky top-0 bg-[#0f172a] text-gray-200">
        <tr>
          <th class="px-3 py-2">Document</th>
          <th class="px-3 py-2">Chunks</th>
          <th class="px-3 py-2">Min page</th>
          <th class="px-3 py-2">Max page</th>
          <th class="px-3 py-2">Last seen</th>
          <th class="px-3 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="indexedDocsTbody" class="divide-y divide-gray-800"></tbody>
    </table>
  </div>
</section>

  </main>

  <div id="docsPreviewModal" class="docs-modal docs-hidden" role="dialog" aria-modal="true">
    <div class="docs-modal-content" role="document">
      <div class="docs-modal-header">
        <h3 id="docsPreviewTitle">Preview</h3>
        <button id="docsPreviewClose" class="btn-ghost" type="button">Close</button>
      </div>
      <div id="docsPreviewLoading" class="small" style="display:none;">Loading samples...</div>
      <div id="docsPreviewList" class="docs-preview-list"></div>
    </div>
  </div>

  <script type="module" src="/ui/indexedDocsPanel.js?v=1.0.3"></script>
  <script type="module">
    import { API_BASE } from "./config.js";
    
    const form = document.getElementById('uploadForm');
    const filesInput = document.getElementById('files');
    const progressWrap = document.getElementById('progressWrap');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusBox = document.getElementById('statusBox');

    function setProgress(pct, text){
      progressWrap.style.display = 'block';
      progressFill.style.width = pct + '%';
      progressText.textContent = text || (pct + '%');
    }

    function setStatus(ok, msg){
      statusBox.style.display = 'block';
      statusBox.className = 'status ' + (ok ? 'success' : 'error');
      statusBox.textContent = msg;
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      statusBox.style.display = 'none';
      const files = filesInput.files;
      if(!files || !files.length){ setStatus(false, 'Please choose at least one file.'); return; }

      const data = new FormData();
      for (const f of files) data.append('files', f);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', API_BASE + '/api/v1/lawfirm/upload-document');

      xhr.upload.addEventListener('progress', (ev) => {
        if (ev.lengthComputable) {
          const pct = Math.round((ev.loaded / ev.total) * 100);
          setProgress(pct, 'Uploading… ' + pct + '%');
        } else {
          setProgress(15, 'Uploading…');
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          // ingestion done (server will process chunks after upload)
          setProgress(100, 'Processing & indexing…');
          try {
            const res = JSON.parse(xhr.responseText || '{}');
            if (xhr.status >= 200 && xhr.status < 300) {
              setStatus(true, `✅ Uploaded ${Array.isArray(res.files)? res.files.length : ''} file(s) successfully. You can start chatting now.`);
            } else {
              setStatus(false, `❌ Upload failed: ${res.detail || res.message || 'Unknown error'}`);
            }
          } catch (e) {
            if (xhr.status >= 200 && xhr.status < 300) {
              setStatus(true, '✅ Upload complete. You can start chatting now.');
            } else {
              setStatus(false, '❌ Upload failed.');
            }
          }
        }
      };

      xhr.send(data);
      setProgress(5, 'Starting upload…');
    });
  </script>
</body>
</html>
